<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Stack Space Needed</title>
<link rel="stylesheet" href="../../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="../../../index.html" title="Chapter&#160;1.&#160;Lua Primer 0.0">
<link rel="up" href="../miscellaneous.html" title="Miscellaneous">
<link rel="prev" href="std_function.html" title="std::function">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="std_function.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../miscellaneous.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="lua_primer.reference.miscellaneous.stack_space_needed"></a><a class="link" href="stack_space_needed.html" title="Stack Space Needed">Stack
        Space Needed</a>
</h4></div></div></div>
<p>
          One aspect of lua that you may miss on your first pass through the manual
          is the note about stack overflow.
        </p>
<p>
          lua's stack has only a limited size. In current versions of lua it is quite
          high, e.g. more than ten thousand elements, but in past versions it may
          have only been a few hundred elements. With eris, it is somewhat smaller
          than in a default configuration for various reasons. The stack space may
          also depend on the integer sizes that lua is configured to use.
        </p>
<p>
          lua does not perform any bounds checking. When you push a string or an
          integer, etc., if there is not enough space in the stack left, you get
          undefined behavior.
        </p>
<p>
          This is of course to avoid the overhead of constant bounds checking. It
          is expected that when you perform a "large" operation you might
          do some bounds checking at the beginning, having an estimate of how much
          clearance you need. The <code class="computeroutput"><span class="identifier">lua_checkstack</span></code>
          function can tell you if there is enough space for a given number of extra
          slots.
        </p>
<p>
          In <code class="computeroutput"><span class="identifier">primer</span></code>, we support pushing
          complex containers in a single operation. For that to be workable, we need
          to give you a way to figure out how much stack clearance is needed to succeed.
        </p>
<p>
          We provide some <code class="computeroutput"><span class="keyword">constexpr</span></code>
          functions that can do that for you.
        </p>
<h4>
<a name="lua_primer.reference.miscellaneous.stack_space_needed.h0"></a>
          <span><a name="lua_primer.reference.miscellaneous.stack_space_needed.maybe_int"></a></span><a class="link" href="stack_space_needed.html#lua_primer.reference.miscellaneous.stack_space_needed.maybe_int"><code class="computeroutput"><span class="identifier">maybe_int</span></code></a>
        </h4>
<p>
          We provide a literal type called <code class="computeroutput"><span class="identifier">maybe_int</span></code>.
        </p>
<p>
          You can think of <code class="computeroutput"><span class="identifier">maybe_int</span></code>
          as a poor man's <code class="computeroutput"><span class="keyword">constexpr</span> <span class="identifier">optional</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span></code>,
          with semantics such that the result of manipulating an unknown value is
          unknown.
        </p>
<p>
          The value is <span class="emphasis"><em>tested</em></span> using <code class="computeroutput"><span class="keyword">operator</span>
          <span class="keyword">bool</span></code>. If the <code class="computeroutput"><span class="identifier">maybe_int</span></code>
          represents a known value, the operator returns <code class="computeroutput"><span class="keyword">true</span></code>.
          If the <code class="computeroutput"><span class="identifier">maybe_int</span></code> represents
          an unknown value, the operator returns <code class="computeroutput"><span class="keyword">false</span></code>.
        </p>
<p>
          In case that there is a known value, it can be queried using <code class="computeroutput"><span class="keyword">operator</span> <span class="special">*</span></code>.
        </p>
<pre class="programlisting"><span class="keyword">using</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">maybe_int</span><span class="special">;</span>

<span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="identifier">x</span> <span class="special">=</span> <span class="identifier">maybe_int</span><span class="special">{</span><span class="number">1</span><span class="special">};</span>
<span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="identifier">y</span> <span class="special">=</span> <span class="identifier">maybe_int</span><span class="special">{</span><span class="number">2</span><span class="special">};</span>
<span class="keyword">constexpr</span> <span class="keyword">auto</span> <span class="identifier">z</span> <span class="special">=</span> <span class="identifier">maybe_int</span><span class="special">{};</span>

<span class="keyword">static_assert</span><span class="special">(</span><span class="identifier">x</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(</span><span class="identifier">y</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(!</span><span class="identifier">z</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(*</span><span class="identifier">x</span> <span class="special">==</span> <span class="number">1</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(*</span><span class="identifier">y</span> <span class="special">==</span> <span class="number">2</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>

<span class="keyword">static_assert</span><span class="special">(</span><span class="identifier">x</span> <span class="special">+</span> <span class="identifier">y</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(*(</span><span class="identifier">x</span> <span class="special">+</span> <span class="identifier">y</span><span class="special">)</span> <span class="special">==</span> <span class="number">3</span><span class="special">,</span> <span class="string">""</span><span class="special">);</span>
<span class="keyword">static_assert</span><span class="special">(!(</span><span class="identifier">x</span> <span class="special">+</span> <span class="identifier">z</span><span class="special">),</span> <span class="string">""</span><span class="special">);</span>
</pre>
<p>
          <code class="computeroutput"><span class="identifier">maybe_int</span></code> supports addition,
          subtraction, and multiplication, with <code class="computeroutput"><span class="keyword">int</span></code>
          and with other <code class="computeroutput"><span class="identifier">maybe_int</span></code>.
          The result is always a <code class="computeroutput"><span class="identifier">maybe_int</span></code>.
        </p>
<p>
          The <code class="computeroutput"><span class="identifier">min</span></code> and <code class="computeroutput"><span class="identifier">max</span></code> can be computed by <code class="computeroutput"><span class="identifier">maybe_int</span><span class="special">::</span><span class="identifier">min</span></code> and <code class="computeroutput"><span class="identifier">maybe_int</span><span class="special">::</span><span class="identifier">max</span></code>.
        </p>
<h4>
<a name="lua_primer.reference.miscellaneous.stack_space_needed.h1"></a>
          <span><a name="lua_primer.reference.miscellaneous.stack_space_needed.querying_stack_space_for_an_oper"></a></span><a class="link" href="stack_space_needed.html#lua_primer.reference.miscellaneous.stack_space_needed.querying_stack_space_for_an_oper">Querying
          stack space for an operation</a>
        </h4>
<p>
          For convenience, we provide two functions which can estimate the stack
          space needed for a read or push operation with a given type.
        </p>
<pre class="programlisting"><span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="keyword">constexpr</span> <span class="identifier">maybe_int</span> <span class="identifier">stack_space_for_read</span><span class="special">()</span> <span class="special">{</span>
  <span class="keyword">return</span> <span class="special">::</span><span class="identifier">primer</span><span class="special">::</span><span class="identifier">stack_space_needed</span><span class="special">&lt;::</span><span class="identifier">primer</span><span class="special">::</span><span class="identifier">traits</span><span class="special">::</span><span class="identifier">read</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;::</span><span class="identifier">value</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<pre class="programlisting"><span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="keyword">constexpr</span> <span class="identifier">maybe_int</span> <span class="identifier">stack_space_for_push</span><span class="special">()</span> <span class="special">{</span>
  <span class="keyword">return</span> <span class="special">::</span><span class="identifier">primer</span><span class="special">::</span><span class="identifier">stack_space_needed</span><span class="special">&lt;::</span><span class="identifier">primer</span><span class="special">::</span><span class="identifier">traits</span><span class="special">::</span><span class="identifier">push</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;::</span><span class="identifier">value</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          If the resulting <code class="computeroutput"><span class="identifier">maybe_int</span></code>
          is vacant (<code class="computeroutput"><span class="keyword">operator</span> <span class="keyword">bool</span></code>
          returns false), it means that no estimate was possible, for lack of information.
          This may happen if a user-defined container or type doesn't provide an
          estimate, by accident, or because no upper bound is possible for a given
          type without knowledge of its runtime value.
        </p>
<p>
          Currently we cannot provide an estimate for "visitable structures",
          although we would like to fix that. For the other types and containers
          that are built-in to primer, we do provide an accurate estimate.
        </p>
<p>
          Primer also uses these estimates interally. For instance, the <code class="computeroutput"><span class="identifier">adapt</span></code> mechanism will compute at compile-time
          a conservative estimate of how much space it needs to read the arguments
          off of the stack, and call <code class="computeroutput"><span class="identifier">lua_checkstack</span></code>
          before it begins. (<code class="computeroutput"><span class="identifier">adapt</span></code>
          also knows that it can skip the check unless the estimate exceeds <code class="computeroutput"><span class="identifier">LUA_MINSTACK</span></code>.)
        </p>
<p>
          It also does such checks when calling a bound-function or coroutine.
        </p>
<p>
          It does not do any checks when you are just calling <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">push</span></code>
          or <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">read</span></code>.
        </p>
<p>
          If you don't define a <code class="computeroutput"><span class="identifier">stack_space_needed</span></code>
          value for a custom specialization of <code class="computeroutput"><span class="identifier">push</span></code>
          or <code class="computeroutput"><span class="identifier">read</span></code>, then primer can't
          form an estimate and will just skip the stack space checks.
        </p>
<h5>
<a name="lua_primer.reference.miscellaneous.stack_space_needed.h2"></a>
          <span><a name="lua_primer.reference.miscellaneous.stack_space_needed.providing_stack_space_estimates"></a></span><a class="link" href="stack_space_needed.html#lua_primer.reference.miscellaneous.stack_space_needed.providing_stack_space_estimates">Providing
          stack space estimates</a>
        </h5>
<p>
          To provide a stack space estimate, when you specialize <code class="computeroutput"><span class="identifier">push</span></code>
          or <code class="computeroutput"><span class="identifier">read</span></code>, you should provide
          a class member:
        </p>
<p>
          <code class="computeroutput"><span class="keyword">static</span> <span class="keyword">constexpr</span>
          <span class="identifier">maybe_int</span> <span class="identifier">stack_space_needed</span><span class="special">{</span><span class="number">4</span><span class="special">};</span></code>
        </p>
<p>
          if e.g. four additional stack spaces are needed to complete the operation.
        </p>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top">
<p>
            When defining <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">traits</span><span class="special">::</span><span class="identifier">push</span><span class="special">::</span><span class="identifier">stack_space_needed</span></code>,
            the value should be the smallest value <code class="computeroutput"><span class="identifier">X</span></code>
            such that if <code class="computeroutput"><span class="identifier">lua_checkstack</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">X</span><span class="special">)</span></code> returns true, then the push operation
            will always succed without exausting the stack. This value is always
            at least one -- <code class="computeroutput"><span class="identifier">push</span></code>
            should always push something at the end, even if it is just <code class="computeroutput"><span class="identifier">nil</span></code>. It may be larger for complex objects
            like containers, and may depend on the template parameters in that case.
          </p>
<p>
            If you don't define it, it is the same as defining it to "unknown".
          </p>
</td></tr>
</table></div>
<div class="note"><table border="0" summary="Note">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="../../../images/note.png"></td>
<th align="left">Note</th>
</tr>
<tr><td align="left" valign="top">
<p>
            When defining <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">traits</span><span class="special">::</span><span class="identifier">read</span><span class="special">::</span><span class="identifier">stack_space_needed</span></code>,
            the value should be the smallest value <code class="computeroutput"><span class="identifier">X</span></code>
            such that if <code class="computeroutput"><span class="identifier">lua_checkstack</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">X</span><span class="special">)</span></code> returns true, then the read operation
            will always succeed without exhausting the stack. This value is always
            at least zero. It may be larger for more complex objects.
          </p>
<p>
            If you don't define it, it is the same as defining it to "unknown".
          </p>
</td></tr>
</table></div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2016 Chris Beck<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="std_function.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../miscellaneous.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a>
</div>
</body>
</html>
