<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>coroutine</title>
<link rel="stylesheet" href="../../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="../../../index.html" title="Chapter&#160;1.&#160;Lua Primer 0.0">
<link rel="up" href="../core.html" title="Core">
<link rel="prev" href="bound_function.html" title="bound_function">
<link rel="next" href="../containers.html" title="Containers">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="bound_function.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../core.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../containers.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="lua_primer.reference.core.coroutine"></a><a class="link" href="coroutine.html" title="coroutine">coroutine</a>
</h4></div></div></div>
<p>
          A <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">coroutine</span></code> is a <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">lua_ref</span></code>
          which represents a lua coroutine, or thread, as they are variously called
          in the documentation.
        </p>
<p>
          In lua, a coroutine is like a function call which is permitted to <code class="computeroutput"><span class="identifier">yield</span></code>, rather than return a value or
          produce an error. <code class="computeroutput"><span class="identifier">yield</span></code>
          stops the execution at the point of yield. If the coroutine is "resumed"
          later, then execution starts up again at the yield point, not at the beginning
          of the function.
        </p>
<p>
          A <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">coroutine</span></code>, unlike a general coroutine,
        </p>
<div class="itemizedlist"><ul class="itemizedlist" type="disc">
<li class="listitem">
              Can only be created from <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">bound_function</span></code>.
            </li>
<li class="listitem">
              Exists only in the registry.
            </li>
</ul></div>
<p>
          <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">coroutine</span></code> is merely a helper object to
          give a nice interface for "calling" the coroutine, similar to
          <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">bound_function</span></code>. It abstracts away the
          details of manipulating thread stacks. Not all uses of coroutines are well-served
          by the <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">coroutine</span></code> object.
        </p>
<p>
          The coroutine can be called again and again, provided that it yields each
          time. After it returns or produces an error, it goes to an empty state
          and needs to be recreated from a <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">bound_function</span></code>.
        </p>
<div class="caution"><table border="0" summary="Caution">
<tr>
<td rowspan="2" align="center" valign="top" width="25"><img alt="[Caution]" src="../../../images/caution.png"></td>
<th align="left">Caution</th>
</tr>
<tr><td align="left" valign="top">
<p>
            lua thread's have nothing to do with operating system threads, it an
            unfortunate name collision.
          </p>
<p>
            Lua is not thread-safe, and coroutines are not a way to make it thread-safe
            somehow.
          </p>
</td></tr>
</table></div>
<pre class="programlisting"><span class="keyword">class</span> <span class="identifier">coroutine</span> <span class="special">{</span>

  <span class="identifier">lua_ref</span> <span class="identifier">ref_</span><span class="special">;</span>
  <span class="identifier">lua_State</span> <span class="special">*</span> <span class="identifier">thread_stack_</span><span class="special">;</span>


<span class="keyword">public</span><span class="special">:</span>
  <span class="comment">// Special member functions</span>
  <span class="identifier">coroutine</span><span class="special">()</span> <span class="keyword">noexcept</span> <span class="special">:</span> <span class="identifier">ref_</span><span class="special">(),</span> <span class="identifier">thread_stack_</span><span class="special">(</span><span class="keyword">nullptr</span><span class="special">)</span> <span class="special">{}</span>

  <span class="identifier">coroutine</span><span class="special">(</span><span class="identifier">coroutine</span> <span class="special">&amp;&amp;)</span> <span class="keyword">noexcept</span> <span class="special">=</span> <span class="keyword">default</span><span class="special">;</span>
  <span class="identifier">coroutine</span> <span class="special">&amp;</span> <span class="keyword">operator</span><span class="special">=(</span><span class="identifier">coroutine</span> <span class="special">&amp;&amp;)</span> <span class="keyword">noexcept</span> <span class="special">=</span> <span class="keyword">default</span><span class="special">;</span>
  <span class="special">~</span><span class="identifier">coroutine</span><span class="special">()</span> <span class="keyword">noexcept</span> <span class="special">=</span> <span class="keyword">default</span><span class="special">;</span>

  <span class="comment">// Noncopyable, delete these.</span>
  <span class="identifier">coroutine</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">coroutine</span> <span class="special">&amp;)</span> <span class="special">=</span> <span class="keyword">delete</span><span class="special">;</span>
  <span class="identifier">coroutine</span> <span class="special">&amp;</span> <span class="keyword">operator</span><span class="special">=(</span><span class="keyword">const</span> <span class="identifier">coroutine</span> <span class="special">&amp;)</span> <span class="special">=</span> <span class="keyword">delete</span><span class="special">;</span>

  <span class="comment">// Construct from bound_function</span>
  <span class="keyword">explicit</span> <span class="identifier">coroutine</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">bound_function</span> <span class="special">&amp;</span> <span class="identifier">bf</span><span class="special">)</span> <span class="keyword">noexcept</span> <span class="comment">//</span>
    <span class="special">:</span> <span class="identifier">coroutine</span><span class="special">()</span>                                        <span class="comment">//</span>
  <span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">lua_State</span> <span class="special">*</span> <span class="identifier">L</span> <span class="special">=</span> <span class="identifier">bf</span><span class="special">.</span><span class="identifier">push</span><span class="special">())</span> <span class="special">{</span>
      <span class="identifier">thread_stack_</span> <span class="special">=</span> <span class="identifier">lua_newthread</span><span class="special">(</span><span class="identifier">L</span><span class="special">);</span>
      <span class="identifier">lua_insert</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="special">-</span><span class="number">2</span><span class="special">);</span>              <span class="comment">// put the thread below the function</span>
      <span class="identifier">lua_xmove</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">thread_stack_</span><span class="special">,</span> <span class="number">1</span><span class="special">);</span> <span class="comment">// Move function to thread stack</span>
      <span class="identifier">ref_</span> <span class="special">=</span> <span class="identifier">lua_ref</span><span class="special">(</span><span class="identifier">L</span><span class="special">);</span>              <span class="comment">// Get ref to the thread</span>
    <span class="special">}</span>
  <span class="special">}</span>


  <span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span><span class="special">...</span> <span class="identifier">Args</span><span class="special">&gt;</span>
  <span class="identifier">expected</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span> <span class="identifier">call_no_ret</span><span class="special">(</span><span class="identifier">Args</span> <span class="special">&amp;&amp;...</span> <span class="identifier">args</span><span class="special">)</span> <span class="keyword">noexcept</span> <a class="co" name="lua_primer.reference.core.coroutine.c0" href="coroutine.html#lua_primer.reference.core.coroutine.c1"><img src="../../../images/callouts/1.png" alt="1" border="0"></a>
  <span class="special">{</span>
    <span class="identifier">expected</span><span class="special">&lt;</span><span class="keyword">void</span><span class="special">&gt;</span> <span class="identifier">result</span><span class="special">;</span>

    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">thread_stack_</span> <span class="special">&amp;&amp;</span> <span class="identifier">ref_</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">int</span> <span class="identifier">error_code</span><span class="special">;</span>

      <span class="identifier">primer</span><span class="special">::</span><span class="identifier">push_each</span><span class="special">(</span><span class="identifier">thread_stack_</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">forward</span><span class="special">&lt;</span><span class="identifier">Args</span><span class="special">&gt;(</span><span class="identifier">args</span><span class="special">)...);</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">tie</span><span class="special">(</span><span class="identifier">result</span><span class="special">,</span> <span class="identifier">error_code</span><span class="special">)</span> <span class="special">=</span>
        <span class="identifier">primer</span><span class="special">::</span><span class="identifier">resume_no_ret</span><span class="special">(</span><span class="identifier">thread_stack_</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">...(</span><span class="identifier">args</span><span class="special">));</span>

      <span class="keyword">if</span> <span class="special">(</span><span class="identifier">error_code</span> <span class="special">!=</span> <span class="identifier">LUA_YIELD</span><span class="special">)</span> <span class="special">{</span> <span class="keyword">this</span><span class="special">-&gt;</span><span class="identifier">reset</span><span class="special">();</span> <span class="special">}</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">result</span> <span class="special">=</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">error</span><span class="special">(</span><span class="string">"Could not lock lua state"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="keyword">return</span> <span class="identifier">result</span><span class="special">;</span>
  <span class="special">}</span>

  <span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span><span class="special">...</span> <span class="identifier">Args</span><span class="special">&gt;</span>
  <span class="identifier">expected</span><span class="special">&lt;</span><span class="identifier">lua_ref</span><span class="special">&gt;</span> <span class="identifier">call_one_ret</span><span class="special">(</span><span class="identifier">Args</span> <span class="special">&amp;&amp;...</span> <span class="identifier">args</span><span class="special">)</span> <span class="keyword">noexcept</span> <a class="co" name="lua_primer.reference.core.coroutine.c2" href="coroutine.html#lua_primer.reference.core.coroutine.c3"><img src="../../../images/callouts/2.png" alt="2" border="0"></a>
  <span class="special">{</span>
    <span class="identifier">expected</span><span class="special">&lt;</span><span class="identifier">lua_ref</span><span class="special">&gt;</span> <span class="identifier">result</span><span class="special">;</span>

    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">thread_stack_</span> <span class="special">&amp;&amp;</span> <span class="identifier">ref_</span><span class="special">)</span> <span class="special">{</span>
      <span class="keyword">int</span> <span class="identifier">error_code</span><span class="special">;</span>

      <span class="identifier">primer</span><span class="special">::</span><span class="identifier">push_each</span><span class="special">(</span><span class="identifier">thread_stack_</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">forward</span><span class="special">&lt;</span><span class="identifier">Args</span><span class="special">&gt;(</span><span class="identifier">args</span><span class="special">)...);</span>
      <span class="identifier">std</span><span class="special">::</span><span class="identifier">tie</span><span class="special">(</span><span class="identifier">result</span><span class="special">,</span> <span class="identifier">error_code</span><span class="special">)</span> <span class="special">=</span>
        <span class="identifier">primer</span><span class="special">::</span><span class="identifier">resume_one_ret</span><span class="special">(</span><span class="identifier">thread_stack_</span><span class="special">,</span> <span class="keyword">sizeof</span><span class="special">...(</span><span class="identifier">args</span><span class="special">));</span>

      <span class="keyword">if</span> <span class="special">(</span><span class="identifier">error_code</span> <span class="special">!=</span> <span class="identifier">LUA_YIELD</span><span class="special">)</span> <span class="special">{</span> <span class="keyword">this</span><span class="special">-&gt;</span><span class="identifier">reset</span><span class="special">();</span> <span class="special">}</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">result</span> <span class="special">=</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">error</span><span class="special">(</span><span class="string">"Could not lock lua state"</span><span class="special">);</span>
    <span class="special">}</span>

    <span class="keyword">return</span> <span class="identifier">result</span><span class="special">;</span>
  <span class="special">}</span>

  <span class="keyword">explicit</span> <span class="keyword">operator</span> <span class="keyword">bool</span><span class="special">()</span> <span class="keyword">const</span> <span class="keyword">noexcept</span> <span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">thread_stack_</span> <span class="special">&amp;&amp;</span> <span class="identifier">ref_</span><span class="special">;</span>
  <span class="special">}</span> <a class="co" name="lua_primer.reference.core.coroutine.c4" href="coroutine.html#lua_primer.reference.core.coroutine.c5"><img src="../../../images/callouts/3.png" alt="3" border="0"></a>

  <span class="keyword">void</span> <span class="identifier">reset</span><span class="special">()</span> <span class="keyword">noexcept</span> <a class="co" name="lua_primer.reference.core.coroutine.c6" href="coroutine.html#lua_primer.reference.core.coroutine.c7"><img src="../../../images/callouts/4.png" alt="4" border="0"></a>
  <span class="special">{</span>
    <span class="identifier">ref_</span><span class="special">.</span><span class="identifier">reset</span><span class="special">();</span>
    <span class="identifier">thread_stack_</span> <span class="special">=</span> <span class="keyword">nullptr</span><span class="special">;</span>
  <span class="special">}</span>
<span class="special">};</span>
</pre>
<div class="calloutlist"><table border="0" summary="Callout list">
<tr>
<td width="5%" valign="top" align="left"><p><a name="lua_primer.reference.core.coroutine.c1"></a><a href="#lua_primer.reference.core.coroutine.c0"><img src="../../../images/callouts/1.png" alt="1" border="0"></a> </p></td>
<td valign="top" align="left"><p>
              Calls or resumes the coroutine, discards return values. (But not errors.)
            </p></td>
</tr>
<tr>
<td width="5%" valign="top" align="left"><p><a name="lua_primer.reference.core.coroutine.c3"></a><a href="#lua_primer.reference.core.coroutine.c2"><img src="../../../images/callouts/2.png" alt="2" border="0"></a> </p></td>
<td valign="top" align="left"><p>
              Calls or resumes the coroutine, returns one value, or an error
            </p></td>
</tr>
<tr>
<td width="5%" valign="top" align="left"><p><a name="lua_primer.reference.core.coroutine.c5"></a><a href="#lua_primer.reference.core.coroutine.c4"><img src="../../../images/callouts/3.png" alt="3" border="0"></a> </p></td>
<td valign="top" align="left"><p>
              Check if the coroutine is valid to call
            </p></td>
</tr>
<tr>
<td width="5%" valign="top" align="left"><p><a name="lua_primer.reference.core.coroutine.c7"></a><a href="#lua_primer.reference.core.coroutine.c6"><img src="../../../images/callouts/4.png" alt="4" border="0"></a> </p></td>
<td valign="top" align="left"><p>
              Reset to the empty state
            </p></td>
</tr>
</table></div>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2016 Chris Beck<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="bound_function.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../core.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../containers.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
