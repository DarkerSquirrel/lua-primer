<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<title>Optionals</title>
<link rel="stylesheet" href="../../../boostbook.css" type="text/css">
<meta name="generator" content="DocBook XSL Stylesheets V1.75.2">
<link rel="home" href="../../../index.html" title="Chapter&#160;1.&#160;Lua Primer 0.0">
<link rel="up" href="../containers.html" title="Containers">
<link rel="prev" href="heterogeneous_containers.html" title="Heterogeneous Containers">
<link rel="next" href="../api.html" title="API">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<div class="spirit-nav">
<a accesskey="p" href="heterogeneous_containers.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../containers.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../api.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
<div class="section">
<div class="titlepage"><div><div><h4 class="title">
<a name="lua_primer.reference.containers.optionals"></a><a class="link" href="optionals.html" title="Optionals">Optionals</a>
</h4></div></div></div>
<p>
          Primer includes some support for <span class="emphasis"><em>optional</em></span> containers.
        </p>
<p>
          An optional is a container which contains either one or zero of a given
          type. A popular example is <code class="computeroutput"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span></code>
          -- a <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">optional</span></code> type was recently added to C++17.
        </p>
<p>
          Optionals are extremely useful for representing optional parameters to
          a function. In primer, this gives you a flexible way to allow users of
          your callbacks to omit certain arguments.
        </p>
<h5>
<a name="lua_primer.reference.containers.optionals.h0"></a>
          <span><a name="lua_primer.reference.containers.optionals.pushing_optionals"></a></span><a class="link" href="optionals.html#lua_primer.reference.containers.optionals.pushing_optionals">Pushing
          optionals</a>
        </h5>
<p>
          Pushing optionals is straightforward in primer. If the optional is empty,
          then primer will push <code class="computeroutput"><span class="identifier">nil</span></code>.
          If it is occupied, then primer pushes the value.
        </p>
<pre class="programlisting"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span> <span class="identifier">x</span><span class="special">;</span>
<span class="identifier">primer</span><span class="special">::</span><span class="identifier">push</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">x</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_gettop</span><span class="special">(</span><span class="identifier">L</span><span class="special">)</span> <span class="special">==</span> <span class="number">1</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_isnil</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">1</span><span class="special">));</span>

<span class="identifier">x</span> <span class="special">=</span> <span class="number">7</span><span class="special">;</span>
<span class="identifier">primer</span><span class="special">::</span><span class="identifier">push</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">x</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_gettop</span><span class="special">(</span><span class="identifier">L</span><span class="special">)</span> <span class="special">==</span> <span class="number">2</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_isinteger</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">2</span><span class="special">));</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_tointeger</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">2</span><span class="special">)</span> <span class="special">==</span> <span class="number">7</span><span class="special">);</span>
</pre>
<h5>
<a name="lua_primer.reference.containers.optionals.h1"></a>
          <span><a name="lua_primer.reference.containers.optionals.reading_optionals"></a></span><a class="link" href="optionals.html#lua_primer.reference.containers.optionals.reading_optionals">Reading
          optionals</a>
        </h5>
<p>
          Optionals can usefully have at least two different kinds of semantics when
          reading: <span class="emphasis"><em>strict</em></span> and <span class="emphasis"><em>relaxed</em></span>.
        </p>
<p>
          When strictly reading optionals, only values that would round-trip with
          "push" are accepted, and anything that isn't nil or acceptable
          as an instance of the value type, is an error.
        </p>
<pre class="programlisting"><span class="identifier">lua_pushnumber</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">5.5f</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_gettop</span><span class="special">(</span><span class="identifier">L</span><span class="special">)</span> <span class="special">==</span> <span class="number">1</span><span class="special">);</span>

<span class="keyword">auto</span> <span class="identifier">result1</span> <span class="special">=</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">read</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">LUA_NUMBER</span><span class="special">&gt;&gt;(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">1</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">result1</span><span class="special">);</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">LUA_NUMBER</span><span class="special">&gt;</span> <span class="identifier">my_number</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">result1</span><span class="special">;</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">my_number</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(*</span><span class="identifier">my_number</span> <span class="special">==</span> <span class="number">5.5f</span><span class="special">);</span>

<span class="identifier">lua_pushnil</span><span class="special">(</span><span class="identifier">L</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_gettop</span><span class="special">(</span><span class="identifier">L</span><span class="special">)</span> <span class="special">==</span> <span class="number">2</span><span class="special">);</span>

<span class="keyword">auto</span> <span class="identifier">result2</span> <span class="special">=</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">read</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">LUA_NUMBER</span><span class="special">&gt;&gt;(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">2</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">result2</span><span class="special">);</span>

<span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">LUA_NUMBER</span><span class="special">&gt;</span> <span class="identifier">my_number2</span> <span class="special">=</span> <span class="special">*</span><span class="identifier">result2</span><span class="special">;</span>
<span class="identifier">assert</span><span class="special">(!</span><span class="identifier">my_number2</span><span class="special">);</span> <span class="comment">// got an empty state (nil)</span>

<span class="identifier">lua_pushstring</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="string">"foo"</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(</span><span class="identifier">lua_gettop</span><span class="special">(</span><span class="identifier">L</span><span class="special">)</span> <span class="special">==</span> <span class="number">3</span><span class="special">);</span>

<span class="keyword">auto</span> <span class="identifier">result3</span> <span class="special">=</span> <span class="identifier">primer</span><span class="special">::</span><span class="identifier">read</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">LUA_NUMBER</span><span class="special">&gt;&gt;(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">3</span><span class="special">);</span>
<span class="identifier">assert</span><span class="special">(!</span><span class="identifier">result3</span><span class="special">);</span> <span class="comment">// string is not nil or a number</span>
</pre>
<p>
          The main use of course is as function parameters. Given a function taking
          optional parameters like so,
        </p>
<pre class="programlisting"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">result</span> <span class="identifier">maximum</span><span class="special">(</span><span class="identifier">lua_State</span> <span class="special">*</span> <span class="identifier">L</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span> <span class="identifier">x</span><span class="special">,</span> <span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="keyword">int</span><span class="special">&gt;</span> <span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
  <span class="keyword">if</span> <span class="special">(</span><span class="identifier">x</span><span class="special">)</span> <span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">lua_pushinteger</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">std</span><span class="special">::</span><span class="identifier">max</span><span class="special">(*</span><span class="identifier">x</span><span class="special">,</span> <span class="special">*</span><span class="identifier">y</span><span class="special">));</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">lua_pushinteger</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="special">*</span><span class="identifier">x</span><span class="special">);</span>
    <span class="special">}</span>
  <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
    <span class="keyword">if</span> <span class="special">(</span><span class="identifier">y</span><span class="special">)</span> <span class="special">{</span>
      <span class="identifier">lua_pushinteger</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="special">*</span><span class="identifier">y</span><span class="special">);</span>
    <span class="special">}</span> <span class="keyword">else</span> <span class="special">{</span>
      <span class="identifier">lua_pushnil</span><span class="special">(</span><span class="identifier">L</span><span class="special">);</span>
    <span class="special">}</span>
  <span class="special">}</span>
  <span class="keyword">return</span> <span class="number">1</span><span class="special">;</span>
<span class="special">}</span>
</pre>
<p>
          these are the kinds of semantics that primer would give when it is pushed
          to lua:
        </p>
<pre class="programlisting"><span class="identifier">lua_pushcfunction</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="identifier">PRIMER_ADAPT</span><span class="special">(&amp;</span><span class="identifier">maximum</span><span class="special">));</span>
<span class="identifier">lua_setglobal</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="string">"maximum"</span><span class="special">);</span>

<span class="identifier">luaL_loadstring</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span>
                <span class="string">"local x = 5                              \n"</span>
                <span class="string">"local y = 7                              \n"</span>
                <span class="string">"assert(maximum(x, y) == 7)               \n"</span>
                <span class="string">"assert(maximum(x, nil) == 5)             \n"</span>
                <span class="string">"assert(maximum(nil, y) == 7)             \n"</span>
                <span class="string">"assert(not maximum(nil, nil))            \n"</span>
                <span class="string">"assert(not pcall(maximum, 'foo', 'bar')) \n"</span>
                <span class="string">"assert(not pcall(maximum, 5, 'bar'))     \n"</span>
                <span class="string">"assert(not pcall(maximum, 'foo', nil))   \n"</span>
                <span class="string">"assert(pcall(maximum, 6, -14))           \n"</span>
                <span class="string">"assert(pcall(maximum, 6))                \n"</span>
                <span class="string">"assert(maximum(6) == 6)                  \n"</span><span class="special">);</span>

<span class="identifier">assert</span><span class="special">(</span><span class="identifier">LUA_OK</span> <span class="special">==</span> <span class="identifier">lua_pcall</span><span class="special">(</span><span class="identifier">L</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">,</span> <span class="number">0</span><span class="special">));</span>
</pre>
<h5>
<a name="lua_primer.reference.containers.optionals.h2"></a>
          <span><a name="lua_primer.reference.containers.optionals.relaxed_semantics"></a></span><a class="link" href="optionals.html#lua_primer.reference.containers.optionals.relaxed_semantics">Relaxed
          semantics</a>
        </h5>
<p>
          In the <span class="emphasis"><em>relaxed</em></span> semantics, we simply try to read an
          instance of the value type. If it succeeds, then that becomes the value
          of the optional. If an error results, then the optional is returned in
          the empty state, and the error is discarded.
        </p>
<p>
          This can be useful, for instance, if you have a complex function which
          takes inputs using a named parameter idiom, and you want it to flexibly
          ignore values that don't make sense. Possibly, the intention is that the
          user will pass some table that also has other uses within your system,
          and if every possible field must match exactly then the interface would
          be too brittle to be used comfortably.
        </p>
<h5>
<a name="lua_primer.reference.containers.optionals.h3"></a>
          <span><a name="lua_primer.reference.containers.optionals.configuring"></a></span><a class="link" href="optionals.html#lua_primer.reference.containers.optionals.configuring">Configuring</a>
        </h5>
<p>
          To give a type optional semantics, we simply specialize push and read for
          it. The built-in semantics are implemented in a header
        </p>
<p>
          <code class="computeroutput"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">primer</span><span class="special">/</span><span class="identifier">container</span><span class="special">/</span><span class="identifier">optional_base</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span></code>
        </p>
<p>
          They can be enabled for an optional type, for example, as follows:
        </p>
<pre class="programlisting"><span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">primer</span><span class="special">/</span><span class="identifier">container</span><span class="special">/</span><span class="identifier">optional_base</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>
<span class="preprocessor">#include</span> <span class="special">&lt;</span><span class="identifier">boost</span><span class="special">/</span><span class="identifier">optional</span><span class="special">/</span><span class="identifier">optional</span><span class="special">.</span><span class="identifier">hpp</span><span class="special">&gt;</span>

<span class="keyword">namespace</span> <span class="identifier">primer</span> <span class="special">{</span>
<span class="keyword">namespace</span> <span class="identifier">traits</span> <span class="special">{</span>

<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="keyword">struct</span> <span class="identifier">push</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;</span> <span class="special">:</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">optional_push</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;</span> <span class="special">{};</span>

<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">T</span><span class="special">&gt;</span>
<span class="keyword">struct</span> <span class="identifier">read</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;</span>
  <span class="special">:</span> <span class="identifier">detail</span><span class="special">::</span><span class="identifier">optional_strict_read</span><span class="special">&lt;</span><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;&gt;</span> <span class="special">{};</span>

<span class="special">}</span> <span class="comment">// end namespace traits</span>
<span class="special">}</span> <span class="comment">// end namespace primer</span>
</pre>
<p>
          If we had selected <code class="computeroutput"><span class="identifier">detail</span><span class="special">::</span><span class="identifier">optional_relaxed_read</span></code>
          instead of <code class="computeroutput"><span class="identifier">detail</span><span class="special">::</span><span class="identifier">optional_strict_read</span></code>, then we would get
          relaxed semantics.
        </p>
<h5>
<a name="lua_primer.reference.containers.optionals.h4"></a>
          <span><a name="lua_primer.reference.containers.optionals.optional_access"></a></span><a class="link" href="optionals.html#lua_primer.reference.containers.optionals.optional_access">Optional
          Access</a>
        </h5>
<p>
          If you have an optional type which differs significantly from <code class="computeroutput"><span class="identifier">boost</span><span class="special">::</span><span class="identifier">optional</span></code> and <code class="computeroutput"><span class="identifier">std</span><span class="special">::</span><span class="identifier">optional</span></code>
          in its interface, then in order to use the above traits implementing the
          strict and relaxed read, you must specialize an additional trait <code class="computeroutput"><span class="identifier">primer</span><span class="special">::</span><span class="identifier">traits</span><span class="special">::</span><span class="identifier">optional_access</span></code> for your type, in order
          to tell primer how to talk to it.
        </p>
<pre class="programlisting"><span class="keyword">namespace</span> <span class="identifier">traits</span> <span class="special">{</span>

<span class="comment">// This trait is used to tell primer in a basic way how to interact with an</span>
<span class="comment">// optional template type.</span>
<span class="comment">//</span>
<span class="comment">// optional_access&lt;T&gt; should provide</span>
<span class="comment">//</span>
<span class="comment">// - typedef value_type</span>
<span class="comment">// - static const value_type * as_ptr(const T &amp;) noexcept;</span>
<span class="comment">// - static T make_empty() noexcept;</span>
<span class="comment">// - static T from_value_type(value_type &amp;&amp;) noexcept;</span>
<span class="comment">//</span>
<span class="comment">// as_ptr should return nullptr if the optional is empty, or a pointer to the</span>
<span class="comment">// contained value.</span>
<span class="comment">//</span>
<span class="comment">// make empty should create an empty optional.</span>
<span class="comment">// from_value_type should move-construct an occupied optional.</span>
<span class="comment">//</span>
<span class="comment">// It must be specialized if your optional does not look like `boost::optional`</span>
<span class="comment">// or `std::optional`.</span>
<span class="keyword">template</span> <span class="special">&lt;</span><span class="keyword">typename</span> <span class="identifier">T</span><span class="special">,</span> <span class="keyword">typename</span> <span class="identifier">ENABLE</span> <span class="special">=</span> <span class="keyword">void</span><span class="special">&gt;</span>
<span class="keyword">struct</span> <span class="identifier">optional_access</span> <span class="special">{</span>
  <span class="keyword">using</span> <span class="identifier">value_type</span> <span class="special">=</span> <span class="keyword">typename</span> <span class="identifier">T</span><span class="special">::</span><span class="identifier">value_type</span><span class="special">;</span>

  <span class="identifier">PRIMER_STATIC_ASSERT</span><span class="special">(</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">is_nothrow_constructible</span><span class="special">&lt;</span><span class="identifier">T</span><span class="special">&gt;::</span><span class="identifier">value</span><span class="special">,</span>
                       <span class="string">"optional must be nothrow constructible"</span><span class="special">);</span>

  <span class="comment">// TODO: boost::optional doesn't do this...</span>
  <span class="comment">// PRIMER_STATIC_ASSERT(noexcept(T{std::declval&lt;value_type&gt;()}),</span>
  <span class="comment">//                      "optional must be nothrow constructible from r-value</span>
  <span class="comment">//                      reference to value type");</span>


  <span class="keyword">static</span> <span class="keyword">const</span> <span class="identifier">value_type</span> <span class="special">*</span> <span class="identifier">as_ptr</span><span class="special">(</span><span class="keyword">const</span> <span class="identifier">T</span> <span class="special">&amp;</span> <span class="identifier">t</span><span class="special">)</span> <span class="keyword">noexcept</span> <span class="special">{</span>
    <span class="keyword">return</span> <span class="identifier">t</span> <span class="special">?</span> <span class="special">&amp;*</span><span class="identifier">t</span> <span class="special">:</span> <span class="keyword">nullptr</span><span class="special">;</span>
  <span class="special">}</span>

  <span class="keyword">static</span> <span class="identifier">T</span> <span class="identifier">make_empty</span><span class="special">()</span> <span class="keyword">noexcept</span> <span class="special">{</span> <span class="keyword">return</span> <span class="special">{};</span> <span class="special">}</span>
  <span class="keyword">static</span> <span class="identifier">T</span> <span class="identifier">from_value_type</span><span class="special">(</span><span class="identifier">value_type</span> <span class="special">&amp;&amp;</span> <span class="identifier">v</span><span class="special">)</span> <span class="keyword">noexcept</span> <span class="special">{</span> <span class="keyword">return</span> <span class="identifier">T</span><span class="special">{</span><span class="identifier">std</span><span class="special">::</span><span class="identifier">move</span><span class="special">(</span><span class="identifier">v</span><span class="special">)};</span> <span class="special">}</span>
<span class="special">};</span>

<span class="special">}</span> <span class="comment">// end namespace traits</span>
</pre>
</div>
<table xmlns:rev="http://www.cs.rpi.edu/~gregod/boost/tools/doc/revision" width="100%"><tr>
<td align="left"></td>
<td align="right"><div class="copyright-footer">Copyright &#169; 2016 Chris Beck<p>
        Distributed under the Boost Software License, Version 1.0. (See accompanying
        file LICENSE_1_0.txt or copy at <a href="http://www.boost.org/LICENSE_1_0.txt" target="_top">http://www.boost.org/LICENSE_1_0.txt</a>)
      </p>
</div></td>
</tr></table>
<hr>
<div class="spirit-nav">
<a accesskey="p" href="heterogeneous_containers.html"><img src="../../../images/prev.png" alt="Prev"></a><a accesskey="u" href="../containers.html"><img src="../../../images/up.png" alt="Up"></a><a accesskey="h" href="../../../index.html"><img src="../../../images/home.png" alt="Home"></a><a accesskey="n" href="../api.html"><img src="../../../images/next.png" alt="Next"></a>
</div>
</body>
</html>
